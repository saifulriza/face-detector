(function(r){typeof define=="function"&&define.amd?define(r):r()})(function(){"use strict";class r{constructor(t={}){if(this.initialized=!1,this.options={timeoutDuration:t.timeoutDuration||3e3,onFaceTimeout:t.onFaceTimeout||(()=>{}),onFaceDetected:t.onFaceDetected||(()=>{}),onPupilTimeout:t.onPupilTimeout||(()=>{}),onPupilDetected:t.onPupilDetected||(()=>{}),onInit:t.onInit||(()=>{}),showFaceCircle:t.showFaceCircle!==void 0?t.showFaceCircle:!0,showPupilPoints:t.showPupilPoints!==void 0?t.showPupilPoints:!0,faceCircleColor:t.faceCircleColor||"#ff0000",pupilPointsColor:t.pupilPointsColor||"#ff0000",faceCircleLineWidth:t.faceCircleLineWidth||3,pupilPointsLineWidth:t.pupilPointsLineWidth||3,detectionMode:t.detectionMode||"both",resources:t.resources||{facefinder:"./resources/facefinder.bin",puploc:"./resources/puploc.bin"}},!["face","pupil","both"].includes(this.options.detectionMode))throw new Error('Invalid detection mode. Must be "face", "pupil", or "both"');this.options.showFaceCircle=this.options.showFaceCircle&&(this.options.detectionMode==="face"||this.options.detectionMode==="both"),this.options.showPupilPoints=this.options.showPupilPoints&&(this.options.detectionMode==="pupil"||this.options.detectionMode==="both"),this.lastPupilDetectionTime=Date.now(),this.pupilTimeoutInterval=null,this.lastValidPupilPositions={left:null,right:null},this.smoothingFactor=.7}async init(t){if(!(t instanceof HTMLCanvasElement))throw new Error("Canvas element is required");if(this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.update_memory=pico.instantiate_detection_memory(5),this.options.detectionMode==="face"||this.options.detectionMode==="both"){const o=await(await fetch(this.options.resources.facefinder)).arrayBuffer(),s=new Int8Array(o);this.facefinder_classify_region=pico.unpack_cascade(s)}if(this.options.detectionMode==="pupil"||this.options.detectionMode==="both"){const o=await(await fetch(this.options.resources.puploc)).arrayBuffer(),s=new Int8Array(o);this.do_puploc=lploc.unpack_localizer(s)}this.initialized=!0,this.options.onInit()}rgba_to_grayscale(t,a,o){for(var s=new Uint8Array(a*o),e=0;e<a;++e)for(var i=0;i<o;++i)s[e*o+i]=(2*t[e*4*o+4*i+0]+7*t[e*4*o+4*i+1]+1*t[e*4*o+4*i+2])/10;return s}processFace(t){if(!this.initialized)throw new Error("FaceDetector not initialized. Call init() first");this.ctx.drawImage(t,0,0);const a=this.ctx.getImageData(0,0,640,480).data,o={pixels:this.rgba_to_grayscale(a,480,640),nrows:480,ncols:640,ldim:640},s={shiftfactor:.1,minsize:100,maxsize:1e3,scalefactor:this.options.detectionMode==="pupil"?1.2:1.1};let e=[];if(this.facefinder_classify_region&&(e=pico.run_cascade(o,this.facefinder_classify_region,s),e=this.update_memory(e),e=pico.cluster_detections(e,.2)),this.options.detectionMode==="face"||this.options.detectionMode==="both"){let i=!1;for(let n=0;n<e.length;++n)e[n][3]>50&&(i=!0,this.lastFaceDetectionTime=Date.now(),this.drawDetection(e[n],o),this.options.onFaceDetected(e[n]));!i&&Date.now()-this.lastFaceDetectionTime>this.options.timeoutDuration&&(this.options.onFaceTimeout(),this.lastFaceDetectionTime=Date.now())}else if(this.options.detectionMode==="pupil"){let i=null;for(let n=0;n<e.length;++n)if(e[n][3]>20){i=e[n];break}i?(this.lastValidDet&&(i[0]=i[0]*.3+this.lastValidDet[0]*.7,i[1]=i[1]*.3+this.lastValidDet[1]*.7,i[2]=i[2]*.3+this.lastValidDet[2]*.7),this.lastValidDet=[...i]):this.lastValidDet?i=this.lastValidDet:i=[240,320,200,100],this.drawDetection(i,o)}}drawDetection(t,a){if(this.options.showFaceCircle&&["face","both"].includes(this.options.detectionMode)&&(this.ctx.beginPath(),this.ctx.arc(t[1],t[0],t[2]/2,0,2*Math.PI,!1),this.ctx.lineWidth=this.options.faceCircleLineWidth,this.ctx.strokeStyle=this.options.faceCircleColor,this.ctx.stroke()),this.options.showPupilPoints&&["pupil","both"].includes(this.options.detectionMode)){let o=!1,s=!1;if(this.do_puploc){const e=this.options.detectionMode==="pupil"?.5:.35,i=-.1*t[2];o=this.drawEye(t,a,-.2,"left",e,i),s=this.drawEye(t,a,.2,"right",e,i)}o||s?this.lastPupilDetectionTime=Date.now():Date.now()-this.lastPupilDetectionTime>this.options.timeoutDuration&&this.options.detectionMode==="pupil"&&(this.options.onPupilTimeout(),this.lastPupilDetectionTime=Date.now())}}drawEye(t,a,o,s,e=.35,i=0){let n=t[0]+i,P=t[1]+o*t[2],p=e*t[2];const m=[p,p*.8,p*1.2];let u=[-1,-1];for(let h of m){const[d,f]=this.do_puploc(n,P,h,63,a);if(d>=0&&f>=0){u=[d,f];break}}let[l,c]=u;if(l>=0&&c>=0)return this.lastValidPupilPositions[s]&&(l=l*(1-this.smoothingFactor)+this.lastValidPupilPositions[s].y*this.smoothingFactor,c=c*(1-this.smoothingFactor)+this.lastValidPupilPositions[s].x*this.smoothingFactor),this.lastValidPupilPositions[s]={x:c,y:l},this.ctx.beginPath(),this.ctx.arc(c,l,2,0,2*Math.PI,!1),this.ctx.lineWidth=this.options.pupilPointsLineWidth,this.ctx.strokeStyle=this.options.pupilPointsColor,this.ctx.stroke(),this.options.onPupilDetected({x:c,y:l,eye:s}),!0;if(this.lastValidPupilPositions[s]){const h=this.lastValidPupilPositions[s];return this.ctx.beginPath(),this.ctx.arc(h.x,h.y,2,0,2*Math.PI,!1),this.ctx.lineWidth=this.options.pupilPointsLineWidth,this.ctx.strokeStyle=this.options.pupilPointsColor,this.ctx.stroke(),!0}return!1}start(t){if(!this.initialized)throw new Error("FaceDetector must be initialized first");if(!(t instanceof HTMLVideoElement))throw new Error("Video element is required");this.processInterval=setInterval(()=>this.processFace(t),1e3/30),(this.options.detectionMode==="pupil"||this.options.detectionMode==="both")&&(this.pupilTimeoutInterval=setInterval(()=>{Date.now()-this.lastPupilDetectionTime>this.options.timeoutDuration&&this.options.onPupilTimeout()},1e3))}stop(){this.initialized=!1,this.processInterval&&(clearInterval(this.processInterval),this.processInterval=null),this.pupilTimeoutInterval&&(clearInterval(this.pupilTimeoutInterval),this.pupilTimeoutInterval=null)}}typeof module<"u"&&module.exports?module.exports=r:window.FaceDetector=r});
